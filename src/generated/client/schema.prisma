// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SnsSubmission {
  id          Int      @id @default(autoincrement())
  userId      String   // Authenticated user ID
  bikeId      String   // Selected vehicle ID
  platform    String
  postUrl     String
  status      String   @default("Pending") // Pending, Reporting, Completed

  // Initial Metrics (Self-Reported)
  initialViews Int?    @default(0)
  initialLikes Int?    @default(0)
  
  // Verification Data (Updated later)
  verifiedViews Int?     @default(0)
  verifiedLikes Int?     @default(0)
  verifiedShares Int?    @default(0)
  rewardGranted String?

  // Platform specific data (optional for expansion)
  metricsJson   String?  // JSON string for raw metrics (likes, views, comments)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          String    @default("USER") // USER, ADMIN, STAFF
  permissions   String?   @default("[]") // JSON string of allowed permissions
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Payment Preferences
  preferredCurrency String @default("USD") // USD, EUR, GBP, EGP

  // Profile Info
  memberType       String    @default("INDIVIDUAL") // INDIVIDUAL, CORPORATE
  phoneNumber      String?
  address          String?
  
  // Corporate Defaults (Optional)
  corporateName    String?
  corporateRegNum  String? // Corporate Registration Number
  representative   String? // Representative Name

  // System ID
  memberId         String?   @unique // Format: XX-XXXXXX (e.g. JP-X9A2M4)

  // KYC Info
  kycStatus        String    @default("NONE") // NONE, PENDING, VERIFIED, REJECTED
  kycDocuments     KycDocument[]
  orders           Order[]
  bids             Bid[]
}

model KycDocument {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String   // PASSPORT, DRIVERS_LICENSE, ID_CARD, UTILITY_BILL, BANK_STATEMENT, COMPANY_REGISTRATION, POA, OTHER
  fileUrl     String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionReason String?
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Bike {
  id                String   @id @default(uuid())
  bdsId             String   @unique
  lane              String?
  auctionNumber     String?
  auctionDate       String?
  name              String
  maker             String?
  makerConfirmed    Boolean  @default(false)
  region            String?
  inspectionStatus  String?
  listingType       String?
  vin               String?
  engineNumber      String?
  mileage           String?
  documentMileage   String?
  pastMileage       String?
  color             String?
  displacement      String?
  firstRegistration String?
  inspection        String?
  hasParts          String?
  registrationNumber String?
  
  startPrice        Int      @default(0)
  currentPrice      Int      @default(0) // For auction state
  result            String?

  // Grades (0-10 scale)
  overallGrade      Float?
  engineGrade       Float?
  frontGrade        Float?
  exteriorGrade     Float?
  rearGrade         Float?
  electricGrade     Float?
  frameGrade        Float?
  
  // AWA Grade
  awaGrade          String?  @default("D") // S, A, B, C, D

  // Rich Text / JSON fields
  inspectionDetails String?  @default("{}") // JSON: { engine: {}, ... }
  awaReport         String?
  sellerDeclaration String?
  images            String?  @default("[]") // JSON array of URLs
  videoUrls         String?  @default("[]") // JSON array of URLs
  remarks           String?  @default("[]") // JSON array of remarks

  // Status
  status            String   @default("active") // pending, active, sold, draft
  importedAt        DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  orders            Order[]
  bids              Bid[]
}

model Order {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  bikeId          String
  bike            Bike     @relation(fields: [bikeId], references: [id])
  
  // Payment Details
  totalAmount     Int      // In JPY
  currency        String   @default("JPY")
  exchangeRate    Float    @default(1.0)
  
  paymentMethod   String   @default("BANK") // BANK, CARD
  status          String   @default("PENDING_PAYMENT") // PENDING_PAYMENT, PAID, SHIPPED, COMPLETED, CANCELLED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Bid {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  bikeId          String
  bike            Bike     @relation(fields: [bikeId], references: [id])
  
  amount          Int
  currency        String   @default("JPY")
  status          String   @default("ACTIVE") // ACTIVE, LOST, WON
  
  createdAt       DateTime @default(now())
}

model Container {
  id          String   @id @default(uuid())
  name        String
  type        String   // 20ft, 40ft
  status      String   // open, closingSoon, scheduled, closed
  destination String
  capacity    Int
  filled      Int
  etd         String?
  eta         String?
  price       String?
  features    String   @default("[]") // JSON array
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Reservation {
  id              String   @id @default(uuid())
  userId          String
  containerId     String
  bikeIds         String   @default("[]") // JSON array of bike IDs
  shippingAddress String   // JSON: { type: '...', details: '...' }
  status          String   @default("pending")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SystemSetting {
  key         String   @id
  value       String   // JSON value
  description String?
  updatedAt   DateTime @updatedAt
}

model ImportLog {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  bikesImported Int
  errors        String   @default("[]") // JSON array of error messages
}

model AdminTask {
  id           String    @id @default(uuid())
  type         String    @default("custom") // "kyc_review", "payment_confirm", "rate_update", "custom"
  title        String
  description  String?
  permissionId String    @default("dashboard") // "users", "finance", "auctions" など
  completed    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  dueDate      DateTime?
  
  // 担当者名（自由入力テキスト）
  assignedToName String?
}
